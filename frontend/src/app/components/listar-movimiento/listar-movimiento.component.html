<div class="nuestroCatalogo d-flex flex-wrap justify-content-around">
  <p style="font-size: 50px;" class="fw-bold my-4">LISTADO DE MOVIMIENTOS</p>
</div>

<!-- Filtros -->
<div class="d-flex flex-wrap justify-content-evenly mb-4 filtros p-2">
  <!-- Local (solo ADMIN) -->
  <div class="input-group m-1" style="width: 300px;" *ngIf="authService.hasRole('ROLE_ADMIN')">
    <select class="form-select" [(ngModel)]="localSeleccionado" (change)="aplicarFiltros()">
      <option [ngValue]="0">Todos los locales</option>
      <option *ngFor="let local of locales" [ngValue]="local.id">{{ local.nombre }}</option>
    </select>
  </div>

  <!-- Tipo -->
  <div class="input-group m-1" style="width: 300px;">
    <select class="form-select" [(ngModel)]="tipoMovimientoSeleccionado" (change)="aplicarFiltros()">
      <option value="">Todos los tipos</option>
      <option value="ENTRADA">ENTRADA</option>
      <option value="SALIDA">SALIDA</option>
    </select>
  </div>

  <!-- Nombre paciente -->
  <div class="input-group m-1" style="width: 300px;">
    <input type="text" class="form-control" placeholder="Nombre Paciente" [(ngModel)]="nombrePaciente" (keyup.enter)="aplicarFiltros()" />
  </div>

  <!-- Fecha -->
  <div class="input-group m-1" style="width: 300px;">
    <input type="date" class="form-control" [(ngModel)]="fechaSeleccionada" (change)="aplicarFiltros()" />
  </div>

  <!-- Método de pago -->
  <div class="input-group m-1" style="width: 300px;">
    <select class="form-select" [(ngModel)]="metodoPagoSeleccionado" (change)="aplicarFiltros()">
      <option value="">Todos los métodos</option>
      <option *ngFor="let metodo of metodosPago" [value]="metodo.nombre">{{ metodo.nombre }}</option>
    </select>
  </div>

  <button class="btn btn-secondary m-1" (click)="limpiarFiltros()">Limpiar Filtros</button>
  <button class="btn btn-success m-1" [routerLink]="['/crearMovimiento']">Registrar Movimiento</button>
</div>

<!-- Totales por método (desde backend, por tenant o local) -->
<div class="container text-center mb-3" *ngIf="authService.hasRole('ROLE_ADMIN')">
  <div class="row g-2 align-items-center justify-content-center">
    <div class="col-auto" *ngFor="let key of getKeys(totalesPorMetodo)">
      <p class="fw-bold mb-1">Total {{ key }}</p>
      <div class="input-group">
        <input
          class="form-control"
          [type]="mostrarTotales ? 'text' : 'password'"
          [value]="totalesPorMetodo[key] | currency"
          readonly
        />
        <button class="btn btn-outline-secondary" type="button" (click)="mostrarTotales = !mostrarTotales">
          <i [class]="mostrarTotales ? 'bi bi-eye-slash' : 'bi bi-eye'"></i>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Sin datos -->
<div class="alert alert-warning mx-5" role="alert" *ngIf="(movimientos?.length || 0) === 0">
  No se encontraron movimientos
</div>

<!-- Tabla -->
<div class="container mt-5 mb-2" *ngIf="(movimientos?.length || 0) > 0">
  <div class="table-responsive" *ngIf="authService.hasRoles()">
    <table class="table table-striped table-bordered table-hover">
      <thead class="table-dark">
        <tr>
          <th class="col-id">N°</th>
          <th class="fecha-col">Fecha Movimiento</th>
          <th>Paciente</th>
          <th>Pagado</th>
          <th>Vendedor</th>
          <th>Local</th>
          <th>Movimiento</th>
          <th>Pagos</th>
          <th *ngIf="authService.hasRoles()">Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let movimiento of movimientos">
          <td class="col-id">{{ movimiento.id }}</td>
          <td class="fecha-col">{{ movimiento.fecha | date: 'yyyy-MM-dd' }}</td>
          <td>{{ movimiento.pacienteNombre }}</td>

          <td>
            <div *ngIf="movimiento.tipoMovimiento === 'ENTRADA'">
              <span *ngIf="esPagoTotal(movimiento)" class="text-success ms-2">✔️</span>
              <span *ngIf="!esPagoTotal(movimiento)" class="text-danger ms-2">❌</span>
            </div>
          </td>

          <td>{{ movimiento.vendedor }}</td>
          <td>{{ movimiento.localNombre }}</td>
          <td>{{ movimiento.tipoMovimiento }}</td>

          <td class="metodo-cobro-col">
            <ul class="mb-0">
              <li *ngFor="let p of movimiento.pagos">
                <span
                  [ngClass]="{
                    'text-success fw-bold': movimiento.tipoMovimiento === 'ENTRADA' && esMismaFechaHoraMinuto(movimiento.fecha, p.fecha),
                    'text-danger fw-bold': movimiento.tipoMovimiento === 'SALIDA' && esMismaFechaHoraMinuto(movimiento.fecha, p.fecha)
                  }"
                >
                  {{ p.metodoPago }} - {{ p.montoImpuesto | currency }}
                </span>
              </li>
            </ul>
          </td>

          <td *ngIf="authService.hasRoles()" class="text-center">
            <div class="d-flex justify-content-center">
              <button class="btn btn-primary btn-sm me-2" [routerLink]="'/editarMovimiento/' + movimiento.id">
                Editar
              </button>
              <button class="btn btn-danger btn-sm me-2" (click)="eliminarMovimiento(movimiento)" *ngIf="authService.hasRole('ROLE_ADMIN')">
                Eliminar
              </button>
              <button class="btn btn-info btn-sm text-white fw-semibold" (click)="copiarEnlace(movimiento.id)" title="Copiar enlace al estado de compra">
                <i class="bi bi-clipboard me-1"></i>
              </button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Paginador -->
  <nav aria-label="Page navigation" *ngIf="paginador && paginador.totalPages > 1 && authService.hasRoles()">
    <ul class="pagination justify-content-center mt-3">
      <li class="page-item" [class.disabled]="paginador.first">
        <a class="page-link cursor-pointer" (click)="cambiarPagina((paginador.number - 1))" aria-label="Previous">
          <span aria-hidden="true">&laquo;</span>
        </a>
      </li>

      <li *ngFor="let page of pages" [class.active]="paginador.number === page" class="page-item">
        <a class="page-link cursor-pointer" (click)="cambiarPagina(page)">{{ page + 1 }}</a>
      </li>

      <li class="page-item" [class.disabled]="paginador.last">
        <a class="page-link cursor-pointer" (click)="cambiarPagina((paginador.number + 1))" aria-label="Next">
          <span aria-hidden="true">&raquo;</span>
        </a>
      </li>
    </ul>
  </nav>
</div>
